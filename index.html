<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <script src='http://d3js.org/d3.v5.min.js' charset='utf-8'></script>
    <script src='http://d3js.org/topojson.v1.min.js'></script>
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    <script>
        const width = 1100;
        const height = 750;

        const svg = d3.select('body').append('svg').attr('width', width).attr('height', height)
            .attr('border-style', 'solid');

        const projection = d3.geoMercator().scale(180).translate([width / 2.1, height / 1.43]);
        const path = d3.geoPath(projection);

        const g = svg.append('g');
        
        var zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on('zoom', function() {
                g.selectAll('path')
                .attr('transform', d3.event.transform);
        });


        var countries = [];     // 22
        var categories = [];    //15
        var populations = [];

        const kickstarterJson = fetch('data/kickstarter.json').then(response => response.json())
            .then(project => {
                for (let i = 0; i < project.length; i++) {
                    if (!countries.includes(project[i].Country)){
                        countries.push(project[i].Country);
                    }

                    if (!categories.includes(project[i].Category)) {
                        categories.push(project[i].Category);
                    }
                }

                console.log(countries);
                console.log(categories);

                getPopulation();
            });
        

        var maxPopulation = 0;
        var minPopulation = 0;

        var minCountry;
        var maxCountry;

        var countriesKickstarter = [];
        var selectedPopulation;

        function getPopulation() {
            const countriesJson = fetch('data/world.json').then(response => response.json())
                .then(country => {
                    minPopulation = country[0].Population;
                    maxPopulation = country[0].Population;
                    
                    for (let i = 0; i < country.length; i++) {
                        if (countries.includes(country[i].Country)) {
                            if (minPopulation > country[i].Population) {
                                minPopulation = country[i].Population;
                                minCountry = country[i].Country;
                            }
                            if (maxPopulation < country[i].Population) {
                                maxPopulation = country[i].Population;
                                maxCountry = country[i].Country;
                            }
                            countriesKickstarter.push(country[i]);
                        }
                        if (i === country.length - 1) {
                            drawMap();
                        }
                    }
                });
        };
        
            
        function drawMap() {
            var tooltipDiv = d3.select("body").append("div")    
                .attr("class", "tooltip")               
                .style("opacity", 0);

            var populationColors = d3.scaleLinear()
                .domain([minPopulation, maxPopulation])
                .range(["#8afa6b", "#1e4214"]);

            d3.json('data/world_map.json').then(data => {
                const countries = topojson.feature(data, data.objects.countries);

                g.selectAll('path').data(countries.features).enter().append('path').attr('class', 'country').attr('id', d => d.properties.name)
                .attr('d', path).style('stroke', 'darkgray').style('stroke-width', 1).style('fill', function(d) {
                    if (d.properties.kickstarter) {
                        var index = countriesKickstarter.findIndex(object => {
                                if (object.Country === d.properties.name) {
                                    return object
                                }
                            });
                        return populationColors(countriesKickstarter[index].Population)
                    }
                    return "lightgray"
                }).on('mouseover', function(d) {
                    getCountryPopulation(d.properties.name)
                    var position = d3.event;
                    setTimeout(function () {
                        tooltipDiv.style('opacity', .9);
                        tooltipDiv.html(d.properties.name + '<br/> Population: ' + selectedPopulation).style('left', position.pageX + 'px')
                            .style('top', (position.pageY - 28) + 'px');
                    }, 4)
                }).on('mouseout', function(d) {
                    tooltipDiv.style('opacity', 0);
                });
            })
        }

        function getCountryPopulation(name) {
            const countriesJson = fetch('data/world.json').then(response => response.json())
                .then(country => {
                    for (let i = 0; i < country.length; i++) {
                        if (country[i].Country === name) {
                            selectedPopulation = country[i].Population;
                        }
                    };
                });
        }

        svg.call(zoom);
    </script>
</body>
</html>